export function floatype(e,t={}){const n={onQuery:null,onNavigate:null,onSelect:null,onRender:null,debounce:100,...t};let o,l,s,i=0,r=[];const u=function(){const t=document.createElement("div");document.querySelector("body").appendChild(t);const n=window.getComputedStyle(e);for(const e of n)t.style[e]=n[e];return t.style.visibility="hidden",t.style.position="absolute",t.style.left="-500%",t.style.top="-500%",t}();function a(t){if("keydown"===t.type&&function(e){if(!o)return!0;switch(e.keyCode){case 38:return d(-1,e);case 40:return d(1,e);case 9:case 32:case 13:return e.preventDefault(),f(i),void p();case 27:return p(),!0}}(t))return;if("blur"===t.type)return void p();const r=function(e){const t=e.value.substring(0,e.selectionStart);if(/\S$/.test(t))return t.match(/\S*$/)[0];return""}(e);r?(l=r,clearTimeout(s),s=setTimeout(c,n.debounce)):p()}async function c(){l&&(r=await n.onQuery(l),r.length?(o||(o=document.createElement("div"),Object.assign(o.style,{width:window.getComputedStyle(e).width,position:"fixed",left:`${e.offsetLeft}px`,top:`${e.offsetTop+e.offsetHeight}px`}),o.classList.add("floatype"),e.parentNode.insertBefore(o,e.nextSibling)),function(){o.innerHTML="";const t=function(e){const t=e.value.substring(0,e.selectionStart),n=Math.max(t.lastIndexOf("\n"),t.lastIndexOf(" "))+1,o="floatype-caret";u.innerHTML=e.value.substring(0,n)+`<span id="${o}" style="display: inline-block;">${e.value.substring(n)}</span>`;const l=document.getElementById(o),s=e.getBoundingClientRect();return{x:s.left+l.offsetLeft-e.scrollLeft,y:s.top+l.offsetTop-e.scrollTop+(parseInt(getComputedStyle(l).height)+5)}}(e);o.style.left=`${t.x}px`,o.style.top=`${t.y}px`,r.forEach(((e,t)=>{const l=document.createElement("div");l.classList.add("floatype-item"),n.onRender?l.appendChild(n.onRender(e)):l.innerText=e,t===i&&l.classList.add("floatype-sel"),l.addEventListener("mousedown",(()=>f(t))),o.appendChild(l)}))}()):p())}function d(e,t){t.preventDefault();const n=o.querySelector(`:nth-child(${i+1})`);n&&n.classList.remove("floatype-sel"),i=(i+e+r.length)%r.length,o.querySelector(`:nth-child(${i+1})`).classList.add("floatype-sel")}function f(t){const o=n.onSelect?n.onSelect(r[t]):r[t];!function(e,t){const n=Math.max(e.value.lastIndexOf(" ",e.selectionStart-1),e.value.lastIndexOf("\n",e.selectionStart-1))+1;e.value=e.value.substring(0,n)+t+(" "!==e.value[e.selectionStart]?" ":"")+e.value.substring(e.selectionStart),e.setSelectionRange(n+t.length+1,n+t.length+1)}(e,o),setTimeout((()=>e.focus()),50)}function p(){r=[],i=0,l=null,o&&(o.remove(),o=null)}return["input","keydown","blur"].forEach((t=>e.addEventListener(t,a))),{unbind:function(){["input","keydown","blur"].forEach((t=>e.removeEventListener(t,a))),p(),u.remove()}}}export default floatype;